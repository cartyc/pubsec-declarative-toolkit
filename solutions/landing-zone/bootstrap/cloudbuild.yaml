steps:
- name: ubuntu
  script: |
    tar -cf /workspace/landing-zone.tar infrastructure
- name: ubuntu
  env:
    - 'PROJECT_ID=$PROJECT_ID'
    - 'COMMIT_SHA=$COMMIT_SHA'
    - 'REGION=northamerica-northeast1'
    - 'KEYRING=landing-zone-oci'
    - 'KEYNAME=landing-zone-oci-signer'
  script: |
    apt update
    apt install wget curl -y
    echo "Install Cosign"
    wget https://github.com/sigstore/cosign/releases/download/v1.13.1/cosign-linux-amd64
    chmod +x cosign-linux-amd64
    mv cosign-linux-amd64 cosign
    echo "Install Oras"
    curl -LO https://github.com/oras-project/oras/releases/download/v0.16.0/oras_0.16.0_linux_amd64.tar.gz
    mkdir -p oras-install/
    tar -zxf oras_0.16.0_*.tar.gz -C oras-install/
    mv oras-install/oras /usr/local/bin/
    rm -rf oras_0.16.0_*.tar.gz oras-install/
    SHA=$(oras push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME/${CONTAINER_NAME} landing-zone.tar | grep Digest: | cut -f2 -d" ")
    echo "SHA"
    echo $SHA
    ./cosign generate-key-pair --kms gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME}
    ./cosign sign --key gcpkms://projects/${PROJECT_ID}/locations/${REGION}/keyRings/${KEYRING}/cryptoKeys/${KEYNAME} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REGISTRY_NAME/${CONTAINER_NAME@${SHA}
options:
  logging: CLOUD_LOGGING_ONLY